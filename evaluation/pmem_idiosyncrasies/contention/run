#!/bin/bash

. ../../common/color.sh

access_sizes=(256 512 1024 2048 4096)
num_threads=(1 2 4 8 16 24)
#access_sizes=(256 512)
#num_threads=(1 2)
runtime=5

for access_size in "${access_sizes[@]}"; do
    echo -e "${COLOR_CYAN}Testing access size $access_size...${COLOR_CLEAR}"
    for num_thread in "${num_threads[@]}"; do
	echo "task=12,op=1,access_size=$access_size,parallel=$num_thread,runtime=$runtime" > /proc/latteste
	throughput=$(($(dmesg | tail "-$runtime" | awk 'BEGIN{s=0;}{s+=$3;}END{print(s)}') / runtime))
	echo -e "${COLOR_GREEN}access_size=$access_size,num_thread=$num_thread,throughput=$throughput${COLOR_CLEAR}"
	echo "$access_size $num_thread $throughput" >> .data
    done
done
